# ๐ ะะฐะบ ัะฐะฑะพัะฐัั satp_client ะธ satp_server

## ๐ก ะััะธัะตะบัััะฐ

```
โโโโโโโโโโโโโโโโโโโโโโโ                    โโโโโโโโโโโโโโโโโโโโโโโ
โ   SATP CLIENT       โ                    โ   SATP SERVER       โ
โ                     โ                    โ                     โ
โ  Device: CANE_001   โ  โโโโโโโโโโโโโโโโโถ โ  Port: 5555 (UDP)  โ
โ  Random Port        โ  UDP Packets       โ  IP: 0.0.0.0        โ
โ  (ะบะปะธะตะฝั ัะฐะผ        โ                    โ  (ัะปััะฐะตั ะฝะฐ ะฒัะตั   โ
โ   ะฒัะฑะธัะฐะตั)         โ โโโโโโโโโโโโโโโโโ  โ   ะธะฝัะตััะตะนัะฐั)      โ
โ                     โ                    โ                     โ
โโโโโโโโโโโโโโโโโโโโโโโ                    โโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ฅ๏ธ **SATP SERVER** 

### ะะพัั ะธ ะฐะดัะตั:

```cpp
uint16_t port = 5555;  // ะะพ ัะผะพะปัะฐะฝะธั
```

**ะะพะถะฝะพ ะธะทะผะตะฝะธัั:**
```bash
./satp_server 8080      # ะะฐะฟัััะธัั ะฝะฐ ะฟะพััั 8080
./satp_server 9999      # ะะฐะฟัััะธัั ะฝะฐ ะฟะพััั 9999
```

### ะะพัะฐะณะพะฒะฐั ัะฐะฑะพัะฐ:

#### 1๏ธโฃ **ะกะพะทะดะฐะฝะธะต UDP ัะพะบะตัะฐ**
```cpp
int udp_socket = socket(AF_INET, SOCK_DGRAM, 0);
//                              โ SOCK_DGRAM = UDP
```

#### 2๏ธโฃ **ะัะธะฒัะทะบะฐ ะบ ะฟะพััั (bind)**
```cpp
struct sockaddr_in server_addr;
server_addr.sin_family = AF_INET;
server_addr.sin_addr.s_addr = INADDR_ANY;  // 0.0.0.0 - ัะปััะฐัั ะฝะฐ ะฒัะตั ะธะฝัะตััะตะนัะฐั
server_addr.sin_port = htons(5555);        // ะะพัั 5555

bind(udp_socket, (struct sockaddr*)&server_addr, sizeof(server_addr));
```

**ะงัะพ ะพะทะฝะฐัะฐะตั `INADDR_ANY` (0.0.0.0)?**
- ะกะตัะฒะตั ัะปััะฐะตั ะฝะฐ **ะะกะะฅ** ัะตัะตะฒัั ะธะฝัะตััะตะนัะฐั:
  - `127.0.0.1` (localhost)
  - `192.168.1.x` (ะปะพะบะฐะปัะฝะฐั ัะตัั)
  - `eth0`, `wlan0` ะธ ั.ะด.

#### 3๏ธโฃ **ะะถะธะดะฐะฝะธะต ะบะปะธะตะฝัะพะฒ (recvfrom)**
```cpp
uint8_t buffer[2048];
struct sockaddr_in client_addr;
socklen_t client_len = sizeof(client_addr);

// ะะปะพะบะธััะตััั ะทะดะตัั ะธ ะถะดัั ะฟะฐะบะตัะพะฒ
ssize_t received = recvfrom(udp_socket,
                           buffer,
                           sizeof(buffer),
                           0,
                           (struct sockaddr*)&client_addr,  // โ ะัะบัะดะฐ ะฟัะธััะป ะฟะฐะบะตั
                           &client_len);

// ะขะตะฟะตัั ะทะฝะฐะตะผ:
// - IP ะฐะดัะตั ะบะปะธะตะฝัะฐ: client_addr.sin_addr
// - ะะพัั ะบะปะธะตะฝัะฐ: client_addr.sin_port
```

#### 4๏ธโฃ **ะะฑัะฐะฑะพัะบะฐ ัะพะพะฑัะตะฝะธั**
```cpp
// ะะตัะตัะธะฐะปะธะทะฐัะธั
deserializeMessage(buffer, received, msg);

// ะะฑัะฐะฑะพัะบะฐ ะฒ ะทะฐะฒะธัะธะผะพััะธ ะพั ัะธะฟะฐ
switch (msg_type) {
    case HELLO:        handleHello();
    case DATA:         handleData();
    case HEARTBEAT:    handleHeartbeat();
    case DISCONNECT:   handleDisconnect();
}
```

#### 5๏ธโฃ **ะัะฟัะฐะฒะบะฐ ะพัะฒะตัะฐ (sendto)**
```cpp
sendto(udp_socket,
       response_packet,
       packet_size,
       0,
       (struct sockaddr*)&client_addr,  // โ ะัะฟัะฐะฒะธัั ะพะฑัะฐัะฝะพ ะบะปะธะตะฝัั
       sizeof(client_addr));
```

### ะะปััะตะฒัะต ะพัะพะฑะตะฝะฝะพััะธ ัะตัะฒะตัะฐ:

โ **ะะพะดะดะตัะถะธะฒะฐะตั ะผะฝะพะถะตััะฒะพ ะบะปะธะตะฝัะพะฒ ะพะดะฝะพะฒัะตะผะตะฝะฝะพ**
```cpp
std::map<std::string, ClientSession> clients_;
// ะะปัั: "192.168.1.100:54321"
// ะะฝะฐัะตะฝะธะต: session info, encryption keys, last_seen
```

โ **ะััะปะตะถะธะฒะฐะตั ะบะฐะถะดัั ัะตััะธั ะพัะดะตะปัะฝะพ**
- Device ID
- Session ID
- Encryption manager (ัะฒะพะธ ะบะปััะธ ะดะปั ะบะฐะถะดะพะณะพ ะบะปะธะตะฝัะฐ!)
- Last seen timestamp

โ **ะะตัะบะพะฝะตัะฝัะน ัะธะบะป ะพะฑัะฐะฑะพัะบะธ**
```cpp
while (is_running_) {
    received = recvfrom(...);  // ะะดะฐัั ัะปะตะดัััะธะน ะฟะฐะบะตั
    handleMessage(...);         // ะะฑัะฐะฑะพัะฐัั
}
```

---

## ๐ฑ **SATP CLIENT**

### ะะพัั ะบะปะธะตะฝัะฐ:

**ะะปะธะตะฝั ะะ ะธัะฟะพะปัะทัะตั ัะธะบัะธัะพะฒะฐะฝะฝัะน ะฟะพัั!**

```cpp
// ะะปะธะตะฝั ัะพะทะดะฐัั ัะพะบะตั
int udp_socket = socket(AF_INET, SOCK_DGRAM, 0);

// ะะ ะดะตะปะฐะตั bind() โ ะพะฟะตัะฐัะธะพะฝะฝะฐั ัะธััะตะผะฐ ัะฐะผะฐ ะฒัะฑะธัะฐะตั ัะปััะฐะนะฝัะน ะฟะพัั!
// ะะฑััะฝะพ ััะพ: 49152-65535 (ephemeral ports)
```

**ะัะธะผะตั:**
```
ะะปะธะตะฝั #1: 127.0.0.1:54321  (ัะปััะฐะนะฝัะน)
ะะปะธะตะฝั #2: 127.0.0.1:54322  (ัะปััะฐะนะฝัะน)
ะะปะธะตะฝั #3: 127.0.0.1:54323  (ัะปััะฐะนะฝัะน)
```

### ะะดัะตั ัะตัะฒะตัะฐ:

```cpp
std::string server_ip = "127.0.0.1";  // ะะพ ัะผะพะปัะฐะฝะธั localhost
uint16_t port = 5555;                 // ะะพัั ัะตัะฒะตัะฐ
```

**ะะพะถะฝะพ ะธะทะผะตะฝะธัั:**
```bash
./satp_client 192.168.1.100 8080    # ะะพะดะบะปััะธัััั ะบ 192.168.1.100:8080
./satp_client 10.0.0.5 9999         # ะะพะดะบะปััะธัััั ะบ 10.0.0.5:9999
```

### ะะพัะฐะณะพะฒะฐั ัะฐะฑะพัะฐ:

#### 1๏ธโฃ **ะกะพะทะดะฐะฝะธะต UDP ัะพะบะตัะฐ**
```cpp
int udp_socket = socket(AF_INET, SOCK_DGRAM, 0);
```

#### 2๏ธโฃ **ะะฐัััะพะนะบะฐ ะฐะดัะตัะฐ ัะตัะฒะตัะฐ**
```cpp
struct sockaddr_in server_addr;
server_addr.sin_family = AF_INET;
server_addr.sin_port = htons(5555);               // ะะพัั ัะตัะฒะตัะฐ
inet_pton(AF_INET, "127.0.0.1", &server_addr.sin_addr);  // IP ัะตัะฒะตัะฐ
```

#### 3๏ธโฃ **Handshake ะฟัะพัะตัั**

**ะจะฐะณ 1: HELLO**
```cpp
SATPMessage hello_msg;
hello_msg.header.message_type = MessageType::HELLO;
hello_msg.payload = "SMART_CANE_001:smart_cane";

// ะัะฟัะฐะฒะธัั ะฝะฐ ัะตัะฒะตั
sendto(udp_socket,
       packet,
       packet_size,
       0,
       (struct sockaddr*)&server_addr,  // โ ะฝะฐ 127.0.0.1:5555
       sizeof(server_addr));
```

**ะจะฐะณ 2: ะะดัะผ HELLO_ACK**
```cpp
recvfrom(udp_socket, buffer, ...);
// ะะพะปััะธะปะธ ะพัะฒะตั ะพั ัะตัะฒะตัะฐ
// ะกะตัะฒะตั ัะตะฟะตัั ะทะฝะฐะตั ะฝะฐั ัะปััะฐะนะฝัะน ะฟะพัั!
```

**ะจะฐะณ 3: KEY_EXCHANGE**
```cpp
sendto(...);  // ะัะฟัะฐะฒะธัั KEY_EXCHANGE
```

**ะจะฐะณ 4: SESSION_READY**
```cpp
recvfrom(...);  // ะะพะปััะธัั SESSION_READY
// โ ะกะพะตะดะธะฝะตะฝะธะต ัััะฐะฝะพะฒะปะตะฝะพ!
```

#### 4๏ธโฃ **ะัะฟัะฐะฒะบะฐ ะดะฐะฝะฝัั**
```cpp
NavigationData nav;
nav.latitude = 51.1605;
nav.longitude = 71.4704;

client.sendNavigationData(nav);
  โ
serializeMessage()
  โ
encryption.encrypt()
  โ
calculateHMAC()
  โ
sendto(udp_socket, ..., server_addr);  // โ ะฝะฐ ัะตัะฒะตั
```

---

## ๐ **ะะพะปะฝะฐั ััะตะผะฐ ะบะพะผะผัะฝะธะบะฐัะธะธ**

```
ะะะะะะข (127.0.0.1:54321)                ะกะะะะะ (0.0.0.0:5555)
        |                                        |
        |  1. HELLO (device info)               |
        |โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโถ |
        |                                        | โข ะกะพะทะดะฐัั ัะตััะธั
        |                                        | โข ะะฝะธัะธะฐะปะธะทะธัะพะฒะฐัั encryption
        |  2. HELLO_ACK (session_id)            |
        | โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ|
        |                                        |
        |  3. KEY_EXCHANGE                      |
        |โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโถ |
        |                                        | โข ะััะตะฝัะธัะธัะธัะพะฒะฐัั
        |  4. SESSION_READY                     |
        | โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ|
        |                                        |
        | โ Connected!                           | โ Client authenticated!
        |                                        |
        |  5. DATA (encrypted navigation)       |
        |โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโถ |
        |                                        | โข Verify HMAC โ
        |                                        | โข Decrypt โ
        |                                        | โข Process โ
        |  6. DATA (coordinates)                |
        |โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโถ |
        |                                        |
        |  7. HEARTBEAT                         |
        |โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโถ |
        |                                        | โข Update last_seen โ
        |  8. DISCONNECT                        |
        |โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโถ |
        |                                        | โข Remove session โ
        |                                        |
```

---

## ๐ **ะะฐะบ ัะฒะธะดะตัั ะฟะพััั ะฒ ัะธััะตะผะต**

### ะะพะณะดะฐ ัะตัะฒะตั ะทะฐะฟััะตะฝ:

```bash
# ะะพัะผะพััะตัั ััะพ ัะปััะฐะตััั ะฝะฐ ะฟะพััั 5555
sudo lsof -i :5555

# ะัะฒะพะด:
COMMAND   PID  USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
satp_serv 1234 user   3u  IPv4  12345      0t0  UDP *:5555
                                              โ
                                    ะกะปััะฐะตั ะฝะฐ ะฒัะตั ะธะฝัะตััะตะนัะฐั
```

### ะะพะณะดะฐ ะบะปะธะตะฝั ะฟะพะดะบะปััะตะฝ:

```bash
# ะะพัะผะพััะตัั ะฒัะต UDP ัะพะตะดะธะฝะตะฝะธั
netstat -an | grep 5555

# ะัะฒะพะด:
udp  0  0  0.0.0.0:5555        0.0.0.0:*           LISTEN    โ ะกะตัะฒะตั
udp  0  0  127.0.0.1:54321     127.0.0.1:5555      ESTABLISHED  โ ะะปะธะตะฝั
           โ ัะปััะฐะนะฝัะน ะฟะพัั    โ ะฟะพัั ัะตัะฒะตัะฐ
```

### ะก ะฟะพะผะพััั ss (ัะพะฒัะตะผะตะฝะฝัะน ัะฟะพัะพะฑ):

```bash
ss -unp | grep 5555

# ะัะฒะพะด:
State    Local Address:Port    Peer Address:Port
UNCONN   0.0.0.0:5555          0.0.0.0:*          users:(("satp_server",pid=1234,fd=3))
UNCONN   127.0.0.1:54321       127.0.0.1:5555     users:(("satp_client",pid=5678,fd=3))
```

---

## ๐ก **ะะฝัะตัะตัะฝัะต ัะฐะบัั**

### 1. ะะพัะตะผั ะบะปะธะตะฝั ะฝะต ะดะตะปะฐะตั bind()?
UDP ัะฒะปัะตััั **connectionless** ะฟัะพัะพะบะพะปะพะผ. ะะปะธะตะฝัั ะฝะต ะฝัะถะตะฝ ัะธะบัะธัะพะฒะฐะฝะฝัะน ะฟะพัั, ะฟะพัะพะผั ััะพ:
- ะะฟะตัะฐัะธะพะฝะฝะฐั ัะธััะตะผะฐ ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฒัะฑะธัะฐะตั ัะฒะพะฑะพะดะฝัะน ะฟะพัั
- ะกะตัะฒะตั ัะทะฝะฐัั ะฐะดัะตั ะบะปะธะตะฝัะฐ ะธะท ะฟะตัะฒะพะณะพ ะฟะฐะบะตัะฐ (recvfrom ะฒะพะทะฒัะฐัะฐะตั `client_addr`)
- ะัะต ะฟะพัะปะตะดัััะธะต ะพัะฒะตัั ะธะดัั ะฝะฐ ััะพั ะฐะดัะตั

### 2. ะะฐะบ ัะตัะฒะตั ัะฐะทะปะธัะฐะตั ะบะปะธะตะฝัะพะฒ?
```cpp
std::string client_key = "IP:Port";
// ะะฐะฟัะธะผะตั: "127.0.0.1:54321"

clients_["127.0.0.1:54321"] = session_info;
clients_["192.168.1.100:49152"] = another_session;
```

### 3. ะ ะตัะปะธ ะบะปะธะตะฝั ะทะฐ NAT?
ะ ัะตะฐะปัะฝะพะน ัะตัะธ ั NAT:
```
[Client] 192.168.1.10:54321
   โ ัะตัะตะท NAT ัะพััะตั
[Internet] 203.0.113.5:12345  โ ะฟัะฑะปะธัะฝัะน IP:ะฟะพัั
   โ
[Server] ะฒะธะดะธั: 203.0.113.5:12345
```

---

## ๐ฏ **ะะตะทัะผะต ะดะปั ะทะฐัะธัั**

| ะะฐัะฐะผะตัั | ะกะตัะฒะตั | ะะปะธะตะฝั |
|----------|--------|--------|
| **ะะพัั** | `5555` (ัะธะบัะธัะพะฒะฐะฝะฝัะน) | ะกะปััะฐะนะฝัะน (49152-65535) |
| **IP ะฐะดัะตั** | `0.0.0.0` (ะฒัะต ะธะฝัะตััะตะนัั) | ะัะฑะธัะฐะตั ะะก |
| **bind()** | โ ะะฐ (ะบ ะฟะพััั 5555) | โ ะะตั (ะะก ัะฐะผะฐ ะฒัะฑะธัะฐะตั) |
| **ะะพะปั** | ะะดัั ะฟะพะดะบะปััะตะฝะธะน | ะะฝะธัะธะธััะตั ะฟะพะดะบะปััะตะฝะธะต |
| **ะะฝะพะถะตััะฒะพ ะฟะพะดะบะปััะตะฝะธะน** | โ ะะฐ (map ะบะปะธะตะฝัะพะฒ) | ะะตั (ะพะดะธะฝ ัะตัะฒะตั) |

**ะะปะฐะฒะฝะพะต:**
- **ะกะตัะฒะตั**: ะคะธะบัะธัะพะฒะฐะฝะฝัะน ะฐะดัะตั `0.0.0.0:5555` - ะฒัะต ะทะฝะฐัั ะบัะดะฐ ะฟะพะดะบะปััะฐัััั
- **ะะปะธะตะฝั**: ะกะปััะฐะนะฝัะน ะฟะพัั - ัะตัะฒะตั ัะทะฝะฐัั ะธะท ะฟะตัะฒะพะณะพ ะฟะฐะบะตัะฐ

---

**ะะพัะพะฒะพ! ะขะตะฟะตัั ะฒั ะทะฝะฐะตัะต ะฒัั ะฟัะพ ะฟะพััั ะธ ัะฐะฑะพัั ะบะปะธะตะฝั-ัะตัะฒะตัะฐ!** ๐
